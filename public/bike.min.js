!function(a){var b={hypot:function(){var a,b=0;for(a in arguments)b+=arguments[a]*arguments[a];return Math.sqrt(b)},intersection:function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p;if(i=d-a,j=e-b,k=Math.sqrt(j*j+i*i),k>c+f||k<Math.abs(c-f))return!1;h=(c*c-f*f+k*k)/(2*k),o=a+i*h/k,p=b+j*h/k,l=Math.sqrt(c*c-h*h),m=-j*(l/k),n=i*(l/k);var q=o+m,r=o-m,s=p+n,t=p-n;return g(q,r,s,t)?{x:q,y:s}:{x:r,y:t}},delta:function(a,b){var c=0,d=0;return c=b.x-a.x,c*=c,d=b.y-a.y,d*=d,Math.sqrt(c+d)},degToRad:function(a){return a*(Math.PI/180)},radToDeg:function(a){return a*(180/Math.PI)},solveSide:function(a,c,d){return Math.sqrt(a*a+c*c-2*a*c*Math.cos(b.degToRad(d)))},sas:function(a,c,d){var e=a*a,f=c*c,g=b.solveSide(a,c,d),h=g*g,i=b.radToDeg(Math.acos((f+h-e)/(2*c*g))),j=180-i-d;return j},posOnCircle:function(a,c,d){var e=b.degToRad(d);return{x:c*Math.cos(e)+a.x,y:c*Math.sin(e)+a.y}},getPosByAngleAndLength:function(a,c,d,e,f){var g=b.degToRad(c),h=Math.sin(g)*d,i=Math.cos(g)*d;return{x:e?a.x-i:a.x+i,y:f?a.y-h:a.y+h}},getAngle:function(a,c){var d=a.y<c.y,e={x:c.x,y:a.y},f=b.delta(a,e),g=b.delta(e,c),h=b.sas(f,g,90);return d?h:-h},rotate:function(a,c,d){var e=b.getAngle(a,c),f=b.posOnCircle(a,b.delta(a,c),e-d);return f}},Bike=a.Bike=function(){this.ankle={right:{x:null,y:null},left:{x:null,y:null}},this.knee={right:{x:null,y:null},left:{x:null,y:null}},this.pedal={radius:172.5,angle:0},this.hip={x:null,y:null},this.wrist={x:null,y:null},this.elbow={right:{x:null,y:null},angle:150},this.head={center:{x:null,y:null},offset:190,diameter:100},this.shoulder={x:null,y:null},this.torsoLength=455,this.upperArmLength=280,this.lowerArmLength=255,this.upperLegLength=425,this.lowerLegLength=410,this.kneeSide="right",this.bottomBracket={x:null,y:null,drop:68},this.seatTube={top:{x:null,y:null},angle:73,length:520},this.chainStay={length:405},this.seatPost={top:{x:null,y:null},length:125},this.seat={back:{x:null,y:null},front:{x:null,y:null},length:75},this.headTube={bottom:{x:null,y:null},top:{x:null,y:null},angle:73,length:150},this.headSet={top:{x:null,y:null},length:50},this.stem={front:{x:null,y:null},length:110,angle:5},this.handlebar={curve:{x:null,y:null},bottom:{x:null,y:null},drop:130,reach:87.5},this.straightFork={bottom:{x:null,y:null},length:370},this.frontWheel={floor:{x:null,y:null},center:{x:null,y:null},diameter:622,tyre:678},this.rearWheel={floor:{x:0,y:0},center:{x:null,y:null},diameter:622,tyre:678},this.stack=553,this.reach=392,this.rake=43};Bike.prototype.updateRearWheel=function(){this.rearWheel.center={x:this.rearWheel.floor.x,y:this.rearWheel.floor.y-this.rearWheel.tyre/2}},Bike.prototype.updateBottomBracket=function(){this.bottomBracket.x=this.rearWheel.center.x+b.hypot(this.bottomBracket.drop,this.chainStay.length),this.bottomBracket.y=this.rearWheel.center.y+this.bottomBracket.drop},Bike.prototype.updateSeatTube=function(){this.seatTube.top=b.getPosByAngleAndLength(this.bottomBracket,this.seatTube.angle,this.seatTube.length,!0,!0)},Bike.prototype.updateSeatPost=function(){this.seatPost.top=b.getPosByAngleAndLength(this.seatTube.top,this.seatTube.angle,this.seatPost.length,!0,!0)},Bike.prototype.updateSeat=function(){this.seat.back.x=this.seatPost.top.x,this.seat.back.y=this.seatPost.top.y,this.seat.front.x=this.seat.back.x+this.seat.length,this.seat.front.y=this.seat.back.y},Bike.prototype.updateHeadTube=function(){this.headTube.top.x=this.bottomBracket.x+this.reach,this.headTube.top.y=this.bottomBracket.y-this.stack,this.headTube.bottom=b.getPosByAngleAndLength(this.headTube.top,this.headTube.angle,this.headTube.length)},Bike.prototype.updateHeadSet=function(){this.headSet.top=b.getPosByAngleAndLength(this.headTube.top,this.headTube.angle,this.headSet.length,!0,!0)},Bike.prototype.updateStem=function(){this.stem.front=b.getPosByAngleAndLength(this.headSet.top,this.stem.angle,this.stem.length,!1,!0)},Bike.prototype.updateHandlebar=function(){this.handlebar.bottom.x=this.stem.front.x,this.handlebar.bottom.y=this.stem.front.y+this.handlebar.drop,this.handlebar.curve.x=this.stem.front.x+this.handlebar.reach,this.handlebar.curve.y=this.stem.front.y+this.handlebar.drop/2},Bike.prototype.updateRake=function(){this.straightFork.bottom=b.getPosByAngleAndLength(this.headTube.bottom,this.headTube.angle,this.straightFork.length);var a=1/Math.sin(b.degToRad(this.headTube.angle))*this.rake;this.frontWheel.center={x:this.straightFork.bottom.x+a,y:this.straightFork.bottom.y},this.frontWheel.floor={x:this.frontWheel.center.x,y:this.frontWheel.center.y+this.frontWheel.tyre/2}},Bike.prototype.rotateFrame=function(){var a=this.rearWheel.center,c=b.getAngle(a,this.frontWheel.center),d=[this.bottomBracket,this.seatTube.top,this.seatPost.top,this.seat.back,this.seat.front,this.headTube.top,this.headTube.bottom,this.headSet.top,this.stem.front,this.handlebar.curve,this.handlebar.bottom,this.straightFork.bottom,this.frontWheel.floor,this.frontWheel.center];d.forEach(function(d){var e=b.rotate(a,d,c);d.x=e.x,d.y=e.y})},Bike.prototype.updateLegs=function(){this.hip.x=this.seat.back.x,this.hip.y=this.seat.back.y,this.ankle.right=b.posOnCircle(this.bottomBracket,this.pedal.radius,this.pedal.angle),this.ankle.left=b.posOnCircle(this.bottomBracket,this.pedal.radius,this.pedal.angle-180),this.knee.right=b.intersection(this.hip.x,this.hip.y,this.upperLegLength,this.ankle.right.x,this.ankle.right.y,this.lowerLegLength,function(a,b){return a>b}),this.knee.left=b.intersection(this.hip.x,this.hip.y,this.upperLegLength,this.ankle.left.x,this.ankle.left.y,this.lowerLegLength,function(a,b){return a>b})},Bike.prototype.updateArms=function(){this.wrist.x=this.handlebar.curve.x,this.wrist.y=this.handlebar.curve.y;var a=b.solveSide(this.upperArmLength,this.lowerArmLength,this.elbow.angle);this.shoulder=b.intersection(this.wrist.x,this.wrist.y,a,this.hip.x,this.hip.y,this.torsoLength,function(a,b,c,d){return d>c}),this.elbow.right=b.intersection(this.shoulder.x,this.shoulder.y,this.upperArmLength,this.wrist.x,this.wrist.y,this.lowerArmLength,function(a,b,c,d){return c>d});var c=Math.atan2(this.shoulder.y-this.hip.y,this.shoulder.x-this.hip.x),d=Math.sin(c)*this.head.offset,e=Math.cos(c)*this.head.offset;this.head.center.x=this.shoulder.x+e,this.head.center.y=this.shoulder.y+d},Bike.prototype.update=function(){this.updateRearWheel(),this.updateBottomBracket(),this.updateSeatTube(),this.updateSeatPost(),this.updateSeat(),this.updateHeadTube(),this.updateHeadSet(),this.updateStem(),this.updateHandlebar(),this.updateRake(),this.rotateFrame(),this.updateLegs(),this.updateArms()}}(window),function(a){var CanvasBike=a.CanvasBike=function(a,b){this.bike=a,this.canvas=b,this.context=this.canvas.getContext("2d"),this.resize(),this.renderFunction=this.render.bind(this),this.animationId=requestAnimationFrame(this.renderFunction)};CanvasBike.prototype.resize=function(){this.width=parseInt(this.canvas.getAttribute("width")||500,10),this.height=parseInt(this.canvas.getAttribute("height")||500,10)},CanvasBike.prototype.resetCanvas=function(){this.canvas.width=this.canvas.width},CanvasBike.prototype.render=function(){this.resetCanvas(),this.updateViewport(),this.context.lineCap="round",this.context.lineJoin="round",this.drawLeg("left","darkgreen"),this.drawCrankarm("left"),this.drawWheel("rearWheel"),this.drawWheel("frontWheel"),this.drawSeat(),this.drawHandlebars(),this.drawFrame(),this.drawChainring(),this.drawCrankarm("right"),this.drawBody(),this.drawHead(),this.drawLeg("right"),this.drawFloor(),requestAnimationFrame(this.renderFunction)},CanvasBike.prototype.updateViewport=function(){var a,b,c=.8,d=this.bike.rearWheel.center.x-this.bike.rearWheel.tyre/2,e=this.bike.frontWheel.center.x+this.bike.frontWheel.tyre/2,f=this.bike.head.center.y-this.bike.head.diameter,g=this.bike.rearWheel.floor.y,h=e-d,i=g-f,j=h/this.width<i/this.height;j?(a=this.height/i*c,b=i/this.height/c):(a=this.width/h*c,b=h/this.width/c);var k=h*a,l=i*a,m=(this.width-k)/2,n=(this.height-l)/2,o=Math.abs(d)+m*b,p=Math.abs(f)+n*b;this.context.scale(a,a),this.context.translate(o,p)},CanvasBike.prototype.beginPath=function(a,b){this.context.strokeStyle=a||"red",this.context.lineWidth=b||26,this.context.beginPath()},CanvasBike.prototype.closePath=function(){this.context.stroke(),this.context.closePath()},CanvasBike.prototype.moveTo=function(a){this.context.moveTo(a.x,a.y)},CanvasBike.prototype.lineTo=function(a){this.context.lineTo(a.x,a.y)},CanvasBike.prototype.circle=function(a,b){this.context.arc(a.x,a.y,b,0,2*Math.PI,!1)},CanvasBike.prototype.quadraticCurveTo=function(a,b){this.context.quadraticCurveTo(a.x,a.y,b.x,b.y)},CanvasBike.prototype.drawFloor=function(){this.beginPath("blue",1),this.context.moveTo(-200,0),this.context.lineTo(this.bike.frontWheel.floor.x+200,0),this.closePath()},CanvasBike.prototype.drawFrame=function(){this.beginPath("red"),this.moveTo(this.bike.seatTube.top),this.lineTo(this.bike.bottomBracket),this.lineTo(this.bike.rearWheel.center),this.lineTo(this.bike.seatTube.top),this.lineTo(this.bike.headTube.top),this.lineTo(this.bike.headTube.bottom),this.lineTo(this.bike.bottomBracket),this.moveTo(this.bike.headTube.bottom),this.quadraticCurveTo(this.bike.straightFork.bottom,this.bike.frontWheel.center),this.closePath()},CanvasBike.prototype.drawWheel=function(a){var b=(this.bike[a].tyre-this.bike[a].diameter)/2;this.beginPath("black",b),this.circle(this.bike[a].center,(this.bike[a].tyre-b)/2),this.closePath()},CanvasBike.prototype.drawCrankarm=function(a){this.beginPath("black"),this.moveTo(this.bike.bottomBracket),this.lineTo(this.bike.ankle[a]),this.closePath()},CanvasBike.prototype.drawChainring=function(){this.beginPath("black"),this.circle(this.bike.bottomBracket,.33*this.bike.pedal.radius),this.closePath()},CanvasBike.prototype.drawHandlebars=function(){this.beginPath("purple"),this.moveTo(this.bike.headTube.top),this.lineTo(this.bike.headSet.top),this.lineTo(this.bike.stem.front),this.quadraticCurveTo({x:this.bike.stem.front.x+this.bike.handlebar.reach,y:this.bike.stem.front.y},this.bike.handlebar.curve),this.quadraticCurveTo({x:this.bike.stem.front.x+this.bike.handlebar.reach,y:this.bike.stem.front.y+this.bike.handlebar.drop},this.bike.handlebar.bottom),this.closePath()},CanvasBike.prototype.drawSeat=function(){this.beginPath("purple"),this.moveTo(this.bike.seatTube.top),this.lineTo(this.bike.seatPost.top),this.lineTo(this.bike.seat.front),this.closePath()},CanvasBike.prototype.drawBody=function(){this.beginPath("green",100),this.moveTo(this.bike.hip),this.lineTo(this.bike.shoulder),this.lineTo(this.bike.elbow.right),this.lineTo(this.bike.wrist),this.closePath()},CanvasBike.prototype.drawHead=function(){this.context.fillStyle="green",this.context.beginPath(),this.circle(this.bike.head.center,this.bike.head.diameter),this.context.closePath(),this.context.fill()},CanvasBike.prototype.drawLeg=function(a,b){this.beginPath(b||"green",100),this.moveTo(this.bike.ankle[a]),this.lineTo(this.bike.knee[a]),this.lineTo(this.bike.hip),this.closePath()}}(window),angular.module("myApp",[]).directive("opBike",function(){return{restrict:"A",scope:!0,controller:["$scope",function(a){a.bike=new Bike}]}}).directive("opCanvasBike",["$window",function(a){return{restrict:"A",link:function(b,c){var d=c[0],e=d.parentNode,f=function(){var a=e.offsetWidth,b=e.offsetHeight;d.setAttribute("width",a),d.setAttribute("height",b)};f();var g=new CanvasBike(b.bike,d);g.render(),a.addEventListener("resize",function(){f(),g.resize()})}}}]).directive("opBikeControls",function(){return{restrict:"A",link:function(a){var b=["bottomBracket.drop","seatTube.angle","seatTube.length","chainStay.length","headTube.angle","headTube.length","headSet.length","handlebar.drop","handlebar.reach","frontWheel.diameter","frontWheel.tyre","rearWheel.center.x","rearWheel.center.y","rearWheel.diameter","rearWheel.tyre","stack","reach","rake","straightFork.length"].map(function(a){return"bike."+a}).join(",");a.$watchCollection("["+b+"]",function(){a.bike.update()})}}}).directive("opCyclistControls",function(){return{restrict:"A",link:function(a){var b=["elbow.angle","torsoLength","upperArmLength","lowerArmLength","upperLegLength","lowerLegLength"].map(function(a){return"bike."+a}).join(",");a.$watchCollection("["+b+"]",function(){a.bike.update()})}}}).directive("opAdjustmentControls",function(){return{restrict:"A",link:function(a){var b=["pedal.radius","pedal.angle","seatPost.length","seat.length","stem.length","stem.angle"].map(function(a){return"bike."+a}).join(",");a.$watchCollection("["+b+"]",function(){a.bike.update()})}}}).directive("opBikeAnimate",function(){return{restrict:"A",link:function(a,b){var c=0,d=1,e=2*Math.PI/d,f=0,g=null;b.on("click",function(){g?(clearInterval(g),g=null):g=setInterval(function(){c==d&&(c=0),a.bike.pedal.angle=f,a.bike.update(),f+=e,c+=1},1e3/60)})}}}).directive("integer",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.unshift(function(a){return parseInt(a,10)})}}});